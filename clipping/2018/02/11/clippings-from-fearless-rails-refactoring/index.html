<!DOCTYPE html>
<html lang="en-us">
<head>
  <title>Clippings from Fearless Rails Refactoring - dsdshome</title>
  <meta charset="utf-8" />
  <meta name="author" content="Yiming Chen" />
  <meta name="keywords" content="Rails, Refactor, Service Object" />

  <link rel="alternate" title="RSS Feed" href="/rss.xml" type="application/rss+xml">
  <link rel="stylesheet" href="/media/css/main.css" type="text/css">
  <link rel="stylesheet" href="/media/css/posts.css" type="text/css">
  <link rel="stylesheet" href="/media/css/prettify.css" type="text/css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/prettify/r298/prettify.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
  <script src="http://netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>

  <script src="/media/js/main.js"></script>
</head>

  <body class="container">
<header id="header">
    <body>
        <nav class="navbar navbar-default navbar-fixed-top" style="opacity: .9" role="navigation">
            <div class="container-fluid">
                <div class="navbar-header">
                    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand" href="/">dsdshome</a>
                </div>
                <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                    <ul class="nav navbar-nav navbar-right">
                        <li><a href="/blog/">Blog</a></li>
                        <li><a href="/clipping/">Clipping</a></li>
                        <li><a href="/tags/">Tags</a></li>
                        <li><a href="/about/">About</a></li>
                        <li><a href="https://github.com/dsdshcym">GitHub</a></li>
                        <li><a href="/rss.xml">RSS</a></li>
                    </ul>
                </div>
            </div>
        </nav>
    </body>
</header>

<section id="content" role="main">
    <div id="outline-container-sec-" class="row" style="padding-top: 70px">
        <div class="col-md-2"></div>
            <h1>Clippings from Fearless Rails Refactoring</h1>
            <div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orgf7a1abd">Rails controllers</a>
<ul>
<li><a href="#orgeaeb61d">What is the problem with Rails controllers?</a></li>
<li><a href="#org8ab5855">Why service objects?</a></li>
<li><a href="#org5826a94">What is a Rails service object?</a></li>
<li><a href="#orgf1dc61c">Refactoring</a></li>
<li><a href="#orgd2b87e7">Refactoring and the human factor</a></li>
<li><a href="#orgc1ff0b7">Tools</a></li>
<li><a href="#orge52df57">How to use this book</a></li>
</ul>
</li>
<li><a href="#org56311dc">Refactoring recipes</a>
<ul>
<li><a href="#org66059c1">Inline controller filters</a></li>
<li><a href="#org4dd23ac">Explicitly render views with locals</a></li>
<li><a href="#org76896c6">Extract render/redirect methods</a></li>
<li><a href="#org904c00e">Extract a Single Action Controller class</a></li>
<li><a href="#org8318687">Extract routing constraint&#xa0;&#xa0;&#xa0;<span class="tag"><span class="SRP">SRP</span></span></a></li>
<li><a href="#org781feed">Extract an adapter object</a></li>
<li><a href="#org118c6db">Extract a repository object</a></li>
<li><a href="#org6aee7ba">Extract a service object using the SimpleDelegator</a></li>
<li><a href="#org9295a9f">Extract conditional validation into Service Object</a></li>
<li><a href="#org4de0f71">Extract a form object</a></li>
</ul>
</li>
<li><a href="#orgeaf8104">Example: TripReservationsController#create</a></li>
<li><a href="#orge44457d">Example: logging time</a></li>
<li><a href="#org5a03843">Patterns</a>
<ul>
<li><a href="#org64f8a93">Instantiating service objects</a>
<ul>
<li><a href="#org5d7c386">Boring Style</a></li>
<li><a href="#org816f44c">Modules</a></li>
<li><a href="#org5fbb10f">Dependor</a></li>
</ul>
</li>
<li><a href="#org5fee871">The repository pattern</a>
<ul>
<li><a href="#orga83edd3">ActiveRecord class as a repository</a></li>
<li><a href="#orgbf20249">Explicit repository object</a></li>
<li><a href="#org4b9093f">No logic in repos</a></li>
<li><a href="#orgaa6a6cf">Transactions</a></li>
<li><a href="#org9584e19">The danger of too small repositories</a></li>
<li><a href="#org263f261">In-memory repository</a></li>
</ul>
</li>
<li><a href="#org4ab7be2">Wrap external API with an adapter</a></li>
<li><a href="#org8929a9d">In-Memory Fake Adapters</a></li>
<li><a href="#org8a7257f">4 ways to early return from a rails controller</a></li>
<li><a href="#org66e0245">Service::Input</a></li>
<li><a href="#orge3c266b">Validations: Contexts</a></li>
<li><a href="#org6412bfa">Validations: Objectify</a></li>
</ul>
</li>
<li><a href="#orgdaee1a2">Testing</a>
<ul>
<li><a href="#orga9127df">Introduction</a></li>
<li><a href="#orgeaa8122">Good test tells a story</a></li>
<li><a href="#orge9d221d">Unit tests vs class tests</a></li>
<li><a href="#org6d6522e">Techniques</a>
<ul>
<li><a href="#orgeb6a59e">Service objects as a way of testing Rails apps (without factory_girl)</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org60a859b">Related topics</a>
<ul>
<li><a href="#orgf629b82">Service controller communication</a></li>
<li><a href="#orgb51ef5e">Naming Conventions</a></li>
<li><a href="#orgb9e81fc">Where to keep services</a></li>
<li><a href="#org4cde6a8">Routing constraints</a></li>
<li><a href="#orgb067103">Rails controller - the lifecycle</a></li>
</ul>
</li>
<li><a href="#orgae5cd8c">Bonus</a>
<ul>
<li><a href="#org5512462">Thanks to repositories</a></li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-orgf7a1abd" class="outline-2">
<h2 id="orgf7a1abd">Rails controllers</h2>
<div class="outline-text-2" id="text-orgf7a1abd">
</div>
<div id="outline-container-orgeaeb61d" class="outline-3">
<h3 id="orgeaeb61d">What is the problem with Rails controllers?</h3>
<div class="outline-text-3" id="text-orgeaeb61d">
<ul class="org-ul">
<li>The problem with Rails controllers:
<ul class="org-ul">
<li>It grows quickly.</li>
<li>Typical patterns are all good on their own, but things start to be
difficult when they are grouped together
<ul class="org-ul">
<li><code>before_filter</code></li>
<li>multiple, nested if-branches</li>
<li>setting @ivars to access them in the view</li>
<li>Controller inheritance</li>
<li>Controller mixins/concerns</li>
</ul></li>
</ul></li>
<li>Why the focus on controllers?
<ol class="org-ol">
<li><b>Controllers are the entry points to your app</b></li>
<li>When the controller contains a mix of concerns, then it's harder
to make other places (views, models) really clean</li>
<li>There's a lot of win (mostly testing), when you make a clear
isolation between the controller and your application
(Though this book tries to be neutral)</li>
</ol></li>
<li>Focus on making the tests run as quickly as possible</li>
<li>Start with small steps (service objects)</li>
<li>The Boy Scout rule</li>
<li>Inspiration
<ul class="org-ul">
<li>Refactoring: Improving the Design of Existing Code</li>
<li>Working Effectively with Legacy Code</li>
<li>Refactoring to Patterns</li>
<li>Clean Code</li>
<li>Ruby Midwest 2011 - Keynote: Architecture the Lost Years by Robert Martin - YouTube</li>
<li>Growing Object-Oriented Software Guided by Tests</li>
<li>Lean Architecture: for Agile Software Development</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org8ab5855" class="outline-3">
<h3 id="org8ab5855">Why service objects?</h3>
<div class="outline-text-3" id="text-org8ab5855">
<ul class="org-ul">
<li>Rails is fast at the beginning, but starts to slow down later:
<ol class="org-ol">
<li>The build is slow</li>
<li>Developer write less tests</li>
<li>Changes cause new bugs</li>
<li>It feels like the app is a monolith instead of a set of nicely
integrated components</li>
</ol></li>
<li>Services are not the silver bullet
<ul class="org-ul">
<li>Goals of services
<ol class="org-ol">
<li>isolate from the Rails HTTP-related parts</li>
<li>faster build time</li>
<li>easier testing</li>
<li>easier reuse for API</li>
<li>less coupling</li>
<li>thinner controllers</li>
</ol></li>
<li>Services are a nice trigger for the whole team
<ul class="org-ul">
<li>encourages discussion</li>
</ul></li>
</ul></li>
<li>Why not service objects?
<ul class="org-ul">
<li>Small app (mostly CRUD)</li>
<li>No frequent bugs</li>
<li>Tests are fast enough</li>
<li>Changes are easy</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org5826a94" class="outline-3">
<h3 id="org5826a94">What is a Rails service object?</h3>
<div class="outline-text-3" id="text-org5826a94">
<ul class="org-ul">
<li>P of EAA: Service Layer</li>
<li>7 Patterns to Refactor Fat ActiveRecord Models - Code Climate Blog</li>
<li>DDD</li>
<li><p>
In the Rails world
</p>
<blockquote>
<p>
Everything that happens in the controller without all the
HTTP-related stuff (params, render, redirect)
</p>
</blockquote>
<ul class="org-ul">
<li>A single process of the business logic</li>
</ul></li>
<li>What it's not
<ul class="org-ul">
<li>SOA</li>
<li>Microservices</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-orgf1dc61c" class="outline-3">
<h3 id="orgf1dc61c">Refactoring</h3>
<div class="outline-text-3" id="text-orgf1dc61c">
<ul class="org-ul">
<li><b>The real skill of refactoring is in balancing the delivery with
maintainability</b></li>
<li>Use <b>small, focused transformations</b>
<ul class="org-ul">
<li>The Transformation Priority Premise - 8th Light</li>
</ul></li>
<li>Introduce temporary duplication when refactoring
<ol class="org-ol">
<li>Safety</li>
<li>Explicit</li>
</ol></li>
</ul>
</div>
</div>
<div id="outline-container-orgd2b87e7" class="outline-3">
<h3 id="orgd2b87e7">Refactoring and the human factor</h3>
<div class="outline-text-3" id="text-orgd2b87e7">
<ul class="org-ul">
<li>A project is a team work
<ul class="org-ul">
<li>People have different perceptions of the goal and the path that
leads to this goal</li>
<li>People have different perceptions of which code is actually good</li>
</ul></li>
<li>Don't refactor for the sake of refactoring
<ul class="org-ul">
<li>Too many bugs?</li>
<li>Too hard to change?</li>
<li>Too slow to run?</li>
</ul></li>
<li>Keep improving refactoring skills to refactor quicker
<ul class="org-ul">
<li>Split the bigger changes into multiple smaller ones</li>
</ul></li>
<li>Time is the measurement
<ul class="org-ul">
<li>Spend time in the best way</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-orgc1ff0b7" class="outline-3">
<h3 id="orgc1ff0b7">Tools</h3>
<div class="outline-text-3" id="text-orgc1ff0b7">
<ul class="org-ul">
<li>Recommend RubyMine for Refactoring/Reviewing Ruby code</li>
</ul>
</div>
</div>
<div id="outline-container-orge52df57" class="outline-3">
<h3 id="orge52df57">How to use this book</h3>
<div class="outline-text-3" id="text-orge52df57">
<ul class="org-ul">
<li>Recipes
<ul class="org-ul">
<li>Prerequisite</li>
<li>Algorithm (Step-by-step)</li>
<li>Examples</li>
<li>Warnings</li>
<li>Benefits</li>
<li>Next Steps</li>
</ul></li>
<li>Examples
<ul class="org-ul">
<li>Typical Rails action refactoring</li>
<li>Real-world controllers</li>
</ul></li>
<li>Patterns
<ul class="org-ul">
<li>Many of the concepts that appeared</li>
</ul></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org56311dc" class="outline-2">
<h2 id="org56311dc">Refactoring recipes</h2>
<div class="outline-text-2" id="text-org56311dc">
</div>
<div id="outline-container-org66059c1" class="outline-3">
<h3 id="org66059c1">Inline controller filters</h3>
<div class="outline-text-3" id="text-org66059c1">
<ul class="org-ul">
<li>The filters introduce coupling between the controller action and the
result of the filters.
<ul class="org-ul">
<li>Global state (instance variables)</li>
</ul></li>
<li>Inline Method</li>
<li>Benefits
<ul class="org-ul">
<li>Eliminate Rails magic</li>
<li>Help reasoning about the code in one place</li>
<li>Move the code that belongs together as a whole</li>
</ul></li>
<li>Warnings
<ul class="org-ul">
<li>Dependencies between filters</li>
<li>It's best to start inlining filter with the last filter</li>
<li><code>render=/=redirect</code> <code>&gt; =render; return=/=redirect; return</code></li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org4dd23ac" class="outline-3">
<h3 id="org4dd23ac">Explicitly render views with locals</h3>
<div class="outline-text-3" id="text-org4dd23ac">
<ul class="org-ul">
<li>The Rails way is to call <code>render</code> implicitly (by following
conventions)
<ol class="org-ol">
<li>The call to render itself</li>
<li>The path to the view file</li>
<li>The way the data is passed to the views</li>
</ol></li>
<li>Algorithm
<ol class="org-ol">
<li>Go to the view</li>
<li>Replace all <code>@foo</code> with <code>foo</code></li>
<li><b>Repeat 1~2 for all the partials</b></li>
<li>The same in the controller</li>
<li>Call <code>render 'products/new', locals: { foo: foo }</code> at the end of
the action</li>
<li>Repeat 1~5 for other instance variables (<code>bar</code>)</li>
</ol></li>
<li>Benefits
<ol class="org-ol">
<li>A clear interface to the view layer</li>
<li>The view behaves more like a proper object</li>
<li>Ease future refactoring
<ol class="org-ol">
<li>Extract Service Object with SimpleDelegator</li>
<li>Extract Single Action Controller class</li>
</ol></li>
</ol></li>
<li>Warnings
<ul class="org-ul">
<li>The locals will not be automatically available in partials, action
view, layout</li>
<li>Look out for methods like <code>instance_variable_get</code></li>
<li>Change tests that check <code>assigns</code></li>
<li>It's better to test controller+view as a black box</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org76896c6" class="outline-3">
<h3 id="org76896c6">Extract render/redirect methods</h3>
<div class="outline-text-3" id="text-org76896c6">
<ul class="org-ul">
<li>Calls to <code>render</code> and <code>redirect</code> are usually very verbose</li>
<li>Explicitly show your intention with method names</li>
<li>Extract methods</li>
<li><p>
We can even go further
</p>
<div class="NOTES">
<p>
Simplify locals with Facade after this refactoring
</p>

</div>
<ul class="org-ul">
<li><p>
From
</p>
<div class="org-src-container">
<pre class="src src-ruby">def render_tree(users)
  render 'tree', locals: { user_count: users.length, users_by_parent: users.group_by(&amp;:invited_by_user_id) }
end
</pre>
</div></li>
<li><p>
To
</p>
<div class="org-src-container">
<pre class="src src-ruby">def render_tree(users_facade)
  render 'tree', locals: { users_facade: users_facade }
end
</pre>
</div></li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org904c00e" class="outline-3">
<h3 id="org904c00e">Extract a Single Action Controller class</h3>
<div class="outline-text-3" id="text-org904c00e">
<ul class="org-ul">
<li>Each action is usually a separate responsibility</li>
<li>Breaking down huge controllers</li>
<li>Reducing the fear of breaking changes</li>
</ul>
</div>
</div>
<div id="outline-container-org8318687" class="outline-3">
<h3 id="org8318687">Extract routing constraint&#xa0;&#xa0;&#xa0;<span class="tag"><span class="SRP">SRP</span></span></h3>
<div class="outline-text-3" id="text-org8318687">
<ul class="org-ul">
<li>One controller action may grow to do more than one thing</li>
<li>Prerequisites
<ul class="org-ul">
<li>Explicitly render views with locals</li>
</ul></li>
<li>SRP</li>
<li>Specifying Constraints - Rails Routing from the Outside In — Ruby on Rails Guides</li>
<li>Routing constraints</li>
</ul>
</div>
</div>
<div id="outline-container-org781feed" class="outline-3">
<h3 id="org781feed">Extract an adapter object</h3>
<div class="outline-text-3" id="text-org781feed">
<ul class="org-ul">
<li>Wrap external API with an adapter</li>
<li>A layer of abstraction around your external libraries</li>
<li>Alistair.Cockburn.us - Hexagonal architecture</li>
<li>Refactoring with Hexagonal Rails</li>
</ul>
</div>
</div>
<div id="outline-container-org118c6db" class="outline-3">
<h3 id="org118c6db">Extract a repository object</h3>
<div class="outline-text-3" id="text-org118c6db">
<ul class="org-ul">
<li>Prerequisites:
<ul class="org-ul">
<li>Inline controller filters</li>
</ul></li>
<li>Benefits
<ol class="org-ol">
<li>A clear persistence API</li>
<li>A new layer (Repositories), a contract to the database</li>
</ol></li>
<li>Warnings</li>
</ul>
</div>
</div>
<div id="outline-container-org6aee7ba" class="outline-3">
<h3 id="org6aee7ba">Extract a service object using the SimpleDelegator</h3>
<div class="outline-text-3" id="text-org6aee7ba">
<ul class="org-ul">
<li>New features tend to be added to controllers
<ol class="org-ol">
<li>Don't quite fit any model</li>
<li>Developers still haven't figured out the domain exactly</li>
</ol></li>
<li>Prerequisites
<ol class="org-ol">
<li>Public Methods
<ul class="org-ul">
<li>Delegator does not delegate <code>protected</code> methods</li>
<li>overwriting method access level after its definition</li>
</ul></li>
<li>Inline controller filters</li>
</ol></li>
<li>Algorithm
<ol class="org-ol">
<li><p>
Move the action definition into new class and inherit from <code>SimpleDelegator</code>.
</p>
<div class="org-src-container">
<pre class="src src-ruby">class PyamentGatewayController &lt; ApplicationController
  class ServiceObject &lt; SimpleDelegator
    def callback
      # copy/pasted method
    end
  end

  def callback
    ServiceObject.new(self).callback
  end
end
</pre>
</div></li>
<li>Step by step bring back controller responsibilities (<code>render</code>,
<code>redirect_to</code>, etc.) into the controller</li>
<li>Remove inheriting from <code>SimpleDelegator</code> (pass in parameters into service
object)</li>
<li>(Optional) Use exceptions for control flow in unhappy paths
<ul class="org-ul">
<li>Performance concern for using exceptions?
<ol class="org-ol">
<li>Cost of using exceptions is negligable when the exception doesn’t
occur.</li>
<li>When the exception occurs its performance cost is 3-4x times lower
compared to one simple SQL statement.</li>
</ol></li>
<li><a href="https://gist.github.com/paneq/a643b9a3cc694ba3eb6e">cost of using exceptions for control flow compared to one SQL statement
(ruby 2.1.4, rails 4.1.7, sqlite) for rails-refactoring.com</a></li>
</ul></li>
</ol></li>
<li>Benefits
<ol class="org-ol">
<li>Extract objects decoupled from HTTP aspect of your application</li>
<li>Cleaner code</li>
<li>A nice boundary between Controller/Service Object</li>
<li>Service objects as a way of testing Rails apps (without factory_girl)</li>
</ol></li>
</ul>
</div>
</div>
<div id="outline-container-org9295a9f" class="outline-3">
<h3 id="org9295a9f">Extract conditional validation into Service Object</h3>
<div class="outline-text-3" id="text-org9295a9f">
<ul class="org-ul">
<li>Introduction (Conditions)
<ol class="org-ol">
<li><code>if=/=unless</code> statements in validation methods</li>
<li>Using <i>virtual</i> <code>attr_accessor</code> to enable/disable a validation</li>
<li><code>on: :create</code> (<code>if: :new_record?</code>)</li>
</ol></li>
<li>Prerequisites
<ul class="org-ul">
<li><b>Conditional validation is used only in one place</b></li>
</ul></li>
<li>Algorithm
<ol class="org-ol">
<li>Make a <code>Validator</code> object from the validation DSL</li>
<li>Assign the validation object to constant</li>
<li>Split <code>save!</code> into validation and saving separately
<ul class="org-ul">
<li><code>Validator.validate</code> doesn't raise any error, so extracting it from model
to service object will break this behavior</li>
<li>Maybe it's better to add a <code>#validate!</code> method to <code>Validator</code>?</li>
</ul></li>
<li>Use the validation in service object
<ol class="org-ol">
<li>Call the validation after calling <code>valid?</code>
<ul class="org-ul">
<li><b><code>valid?</code> is cleaning errors</b> so we need to call it first</li>
</ul></li>
<li>Remove the validation from model</li>
<li>Remove the accessor (validator toggle) from model</li>
</ol></li>
</ol></li>
<li>Benefits
<ul class="org-ul">
<li>Model tends to accumulate knowledge about all the contexts (service objects)
using it</li>
<li><b>Drop the <i>conditional</i> aspect of the validation</b></li>
<li>Let the higher level object deal with nuances of this particular interaction
and its business requirement</li>
</ul></li>
<li>Warnings
<ul class="org-ul">
<li>Validations need to be order-independent</li>
<li>If your validations perform SQL queries, you might need to manually wrap
this with the <code>save</code> transaction</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org4de0f71" class="outline-3">
<h3 id="org4de0f71">Extract a form object</h3>
<div class="outline-text-3" id="text-org4de0f71">
<ul class="org-ul">
<li>Introduction
<ul class="org-ul">
<li><b>Complicated validation logic in your model</b> just to accept proper
parameters submitted by user</li>
<li>Form objects are like <b>boarder guards</b>. <i>Data passed through are assumed as
correct and not examined again</i></li>
</ul></li>
<li><p>
Algorithm
</p>
<div class="org-src-container">
<pre class="src src-ruby">class Signup
  include ActiveModel::Model
  attr_reader :name, :email, :password

  def initialize(params = {})
    @name     = params[:name]
    @email    = params[:email]
    @password = params[:password]
  end

  validates :name, presence: true
  validates :email, presence: true
  validates :password, length: { within: 8..255 }

  def persisted?
    false
  end
end
</pre>
</div>
<ul class="org-ul">
<li><a href="https://github.com/solnic/virtus">solnic/virtus: Attributes on Steroids for Plain Old Ruby Objects</a></li>
</ul></li>
<li>Benefits
<ol class="org-ol">
<li>Remove conditional validations from models</li>
<li>More explicit code</li>
<li>Domain is expressed better</li>
</ol></li>
<li>Warnings
<ol class="org-ol">
<li><code>ActiveModel::Model</code> was introduced in Rails 4</li>
<li><b>Do not add <code>#save</code> method</b>
<ul class="org-ul">
<li>It violates SRP</li>
<li>Persistence is a separate concern and a different object (like service
object) should take care of that</li>
</ul></li>
</ol></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-orgeaf8104" class="outline-2">
<h2 id="orgeaf8104">Example: TripReservationsController#create</h2>
<div class="outline-text-2" id="text-orgeaf8104">
<ul class="org-ul">
<li>Extract a service object
<ul class="org-ul">
<li>It’s usually not a good idea to use a pattern name as part of a class name.</li>
<li>Explicit dependencies
<ul class="org-ul">
<li>Be <b>smell-driven</b></li>
<li>What are suitable for constructor parameters?
<ul class="org-ul">
<li>External dependencies that don't belong to the main logic of application
<ul class="org-ul">
<li>External API</li>
<li>File system</li>
<li>Storage</li>
</ul></li>
<li>Static dependencies that don't change for every call to the service</li>
</ul></li>
<li><b>Good OOP is about sending messages not accessing properties</b></li>
</ul></li>
</ul></li>
<li>Service-Controller communication
<ul class="org-ul">
<li>The main purpose of a service object: <b>do a certain thing</b>
<ol class="org-ol">
<li>registering a user</li>
<li>submitting an order</li>
</ol></li>
<li>How do we deal with failures
<ul class="org-ul">
<li>Exception examples
<dl class="org-dl">
<dt><code>NotAllowedToBook</code>  </dt><dd>You’re not allowed to book from this agency.</dd>
<dt><code>NoTicketsAvailable</code></dt><dd>No free tickets available.</dd>
<dt><code>ReservationError</code>  </dt><dd>Reservation error.</dd>
<dt><code>PaymentProblem</code>    </dt><dd>Payment error.</dd>
</dl></li>
<li>Extracting exceptions
<ol class="org-ol">
<li>Add the exception class
<ul class="org-ul">
<li><b>Add the exception class under the service namespace</b></li>
</ul></li>
<li>Raise the exception</li>
<li>Catch the exception in the controller and move the redirect_to back to
the controller</li>
</ol></li>
</ul></li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-orge44457d" class="outline-2">
<h2 id="orge44457d">Example: logging time</h2>
<div class="outline-text-2" id="text-orge44457d">
<ul class="org-ul">
<li>Change CRUD name to the domain one (CreateTimeEntry -&gt; LogTime)</li>
</ul>
</div>
</div>
<div id="outline-container-org5a03843" class="outline-2">
<h2 id="org5a03843">Patterns</h2>
<div class="outline-text-2" id="text-org5a03843">
</div>
<div id="outline-container-org64f8a93" class="outline-3">
<h3 id="org64f8a93">Instantiating service objects</h3>
<div class="outline-text-3" id="text-org64f8a93">
</div>
<div id="outline-container-org5d7c386" class="outline-4">
<h4 id="org5d7c386">Boring Style</h4>
<div class="outline-text-4" id="text-org5d7c386">
<ul class="org-ul">
<li>Controller
<ul class="org-ul">
<li>Unlike in desktop application, every Rails controller action is an entry
point into the system (<code>main() method</code>)</li>
<li><b>Keep controller actions to be very thin</b>
<ol class="org-ol">
<li>instantiating the right kind of objects</li>
<li>giving them access to the input</li>
<li>putting the whole world in motion</li>
</ol></li>
<li>Controller Testing
<ul class="org-ul">
<li><b>Controllers are the hardest beasts when it come to testing</b></li>
<li>Its purpose is <b>not to determine whether the service is doing its job, but
whether controller is</b></li>
<li><b>Controller's concerns</b>:
<ol class="org-ol">
<li>passing <code>params</code>, <code>request</code> and <code>session</code> (subsets of) data for the
services when they need it</li>
<li>controlling the flow of the interaction by using <code>redirect_to</code> or
<code>render</code></li>
<li>Updating the long-living parts of user interaction with our system such
as <code>session</code> and <code>cookies</code></li>
<li>(<b>Optional because it is more of a view's responsibility</b>) Notifying user
about the achieved result of the actions (<code>flash</code> or <code>flash.now</code>)</li>
</ol></li>
<li><p>
Example
</p>
<div class="org-src-container">
<pre class="src src-ruby">describe ProductsController do
  specify '#create' do
    product_attributes = {
      "name" =&gt; "Product Name",
      "price" =&gt; "123.45"
    }

    metrics = double(:metrics)
    expect(MetricsAdapter).to receive(:new).with("testApiKey").and_return(metrics)

    create_product_service = double(:register_user_service,
                                    call: Product.new.tap { |p| p.id = 10 })
    expect(CreateProductService).to receive(:new).with(metrics).and_return(create_product_service)
  end
end
</pre>
</div></li>
</ul></li>
</ul></li>
<li>Service
<ul class="org-ul">
<li>unit test it</li>
<li>Use dependency injection</li>
<li><p>
Example
</p>
<div class="org-src-container">
<pre class="src src-ruby">describe CreateProducteService do
  let(:metrics_adapter) { FakeMetricsAdapter.new }
  subject(:create_product_service) { described_class.new(metrics_adapter) }

  specify "something something" do
    create_product_service.call(..)
    expect(..)
  end
end
</pre>
</div></li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org816f44c" class="outline-4">
<h4 id="org816f44c">Modules</h4>
<div class="outline-text-4" id="text-org816f44c">
<ul class="org-ul">
<li>Extract the process of creating the full object into an <code>injector</code> <b>when
instantiating becomes more complicated</b>
<ol class="org-ol">
<li>make it easy to create new instance everywhere</li>
<li>make it trivial to overwrite the dependencies by overwriting methods</li>
</ol></li>
<li><p>
Example
</p>
<div class="org-src-container">
<pre class="src src-ruby">module CreateProductServiceInjector
  def metrics_adapter
    @metrics_adapter ||= MetricsAdapter.new( METRICS_CONFIG.fetch(Rails.env) )
  end

  def create_product_service
    @create_product_service ||= CreateProductService.new(metrics_adapter)
  end
end

class ProductsController
  include CreateProductServiceInjector
end
</pre>
</div></li>
<li>Testing
<dl class="org-dl">
<dt>Injector</dt><dd>Test that we can inject the objects and change the dependencies</dd>
<dt>Controller</dt><dd><p>
It doesn't care how to setup services
</p>
<div class="org-src-container">
<pre class="src src-ruby">expect(controller.create_product_service).to receive(:call).with().and_return
</pre>
</div></dd>
<dt>Service Object</dt><dd>Include Injector in the test will make dependency implicit</dd>
</dl></li>
</ul>
</div>
</div>
<div id="outline-container-org5fbb10f" class="outline-4">
<h4 id="org5fbb10f">Dependor</h4>
<div class="outline-text-4" id="text-org5fbb10f">
<ul class="org-ul">
<li><a href="https://github.com/psyho/dependor">psyho/dependor: Simple Dependency Injection/Service Locator framework for Rails-like applications.</a></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org5fee871" class="outline-3">
<h3 id="org5fee871">The repository pattern</h3>
<div class="outline-text-3" id="text-org5fee871">
<p>
<b>Very similar to Ecto.Repo</b>
</p>
<ul class="org-ul">
<li>ActiveRecord is a good library for simple database access, but <b>we need to
move business logic into other places after our application grows</b></li>
</ul>
</div>
<div id="outline-container-orga83edd3" class="outline-4">
<h4 id="orga83edd3">ActiveRecord class as a repository</h4>
<div class="outline-text-4" id="text-orga83edd3">
<ul class="org-ul">
<li>ActiveRecord classes are already repositories</li>
<li><p>
Example
</p>
<div class="org-src-container">
<pre class="src src-ruby">class Post &lt; ActiveRecord::Base
end

class PostController &lt; ApplicationController
  def create
    CreatePostService.new(Post).call(title, content)
    redirect_to :index
  end
end

class CreatePostService
  def initialize(posts_repo)
    @posts_repo = posts_repo
  end

  def call(title, content)
    @posts_repo.create(title: title, content: content)
  end
end
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-orgbf20249" class="outline-4">
<h4 id="orgbf20249">Explicit repository object</h4>
<div class="outline-text-4" id="text-orgbf20249">
<div class="org-src-container">
<pre class="src src-ruby">class PostsRepository
  def index
    Post.all
  end

  def show(id)
    Post.find(id)
  end

  def create(title, content)
    Post.create(title: title, content: content)
  end
end
</pre>
</div>
<ul class="org-ul">
<li><b>Never talk to ActiveRecord outside of the repository object</b></li>
<li>Hide ActiveRecord as a repository implementation detail</li>
</ul>
</div>
</div>
<div id="outline-container-org4b9093f" class="outline-4">
<h4 id="org4b9093f">No logic in repos</h4>
<div class="outline-text-4" id="text-org4b9093f">
<ul class="org-ul">
<li>Repository objects should have no logic at all
<dl class="org-dl">
<dt>Ideally</dt><dd>They don't deal with any typical validations</dd>
<dt>In practice</dt><dd>A temporary situation where your AR classes still have
validations and are hidden behind the repo</dd>
</dl></li>
<li>Repositories let you manipulate and retrieve the data (just some CRUD
operations)</li>
<li>The goal is: <b>to make the whole data layer logic-less</b>
<ul class="org-ul">
<li><b>Move all callbacks out from the models</b></li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-orgaa6a6cf" class="outline-4">
<h4 id="orgaa6a6cf">Transactions</h4>
<div class="outline-text-4" id="text-orgaa6a6cf">
<ul class="org-ul">
<li>It's not the job of the repo object to build transactions (it's service
objects' job)</li>
<li>The repo object can expose a <code>in_transaction</code> method to let caller be explicit
about the boundary</li>
</ul>
</div>
</div>
<div id="outline-container-org9584e19" class="outline-4">
<h4 id="org9584e19">The danger of too small repositories</h4>
<div class="outline-text-4" id="text-org9584e19">
<ul class="org-ul">
<li>Service objects taking multiple repositories is a common code smell</li>
</ul>
</div>
</div>
<div id="outline-container-org263f261" class="outline-4">
<h4 id="org263f261">In-memory repository</h4>
<div class="outline-text-4" id="text-org263f261">
<ul class="org-ul">
<li><p>
Replace a real repo with stubs:
</p>
<div class="org-src-container">
<pre class="src src-ruby">class InMemoryPostsRepo
  def initialize
    @posts = []
  end

  def create(title, content)
    @posts &lt;&lt; Post.new(generate_id, title, content)
  end

  def find(id)
    @posts.detect { |post| post.id == id }
  end
end
</pre>
</div></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org4ab7be2" class="outline-3">
<h3 id="org4ab7be2">Wrap external API with an adapter</h3>
<div class="outline-text-3" id="text-org4ab7be2">
<ul class="org-ul">
<li>Your app is built upon APIs
<ol class="org-ol">
<li>3rd party integration (Twitter, Facebook, internal company API)</li>
<li>Contacting DB</li>
<li>Sending emails</li>
</ol></li>
<li>Wrap internal API exceptions with our own protocol layer
<ul class="org-ul">
<li>Adapters of the same type need to throw the same exceptions</li>
<li><b>What exceptions are raised is part of the interface</b> (Java)</li>
<li>If you want to communicate something domain specific via the exception you
can’t relay on 3rd party exceptions</li>
</ul></li>
<li>Benefits
<ol class="org-ol">
<li>Protect ourselves from the dependency (library/3rd party API), we are free
to change it later</li>
<li><b>Separate our interface from the implementation</b></li>
<li>The API is suitable for our app</li>
<li>Adapters are pluggable</li>
</ol></li>
<li>Describe the interface (duck-typing) using tests</li>
<li><p>
Test interface
</p>
<div class="org-src-container">
<pre class="src src-ruby">expect(described_class.instance_method(:notify).arity).to eq(2)
</pre>
</div></li>
<li>Warnings
<ol class="org-ol">
<li>Adapters' interfaces tends to be lowest common denominator between features
supported by implementations</li>
<li>You won't easily extract Async adapter if you care about the result
<ul class="org-ul">
<li><b>Async is architectural decision here</b></li>
</ul></li>
<li><b>Getting the right level of abstraction for adapter might not be easy</b>
<ul class="org-ul">
<li><a href="https://www.youtube.com/watch?v=yTkzNHF6rMs">RubyConf 12 - Boundaries by Gary Bernhardt - YouTube</a></li>
<li>The closer the adapter is to the domain of adaptee, the easier it is to
write it.</li>
<li>The closer it is to the domain of the client, of your app, the harder it
is, the more it will know about your usecases.</li>
</ul></li>
</ol></li>
<li>Use adapters wisely to decouple core of your app from 3rd party code for
whatever reason you have.
<ul class="org-ul">
<li>Speed</li>
<li>Readability</li>
<li>Testability</li>
<li>Isolation</li>
<li>Interchangeability</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org8929a9d" class="outline-3">
<h3 id="org8929a9d">In-Memory Fake Adapters</h3>
<div class="outline-text-3" id="text-org8929a9d">
<ul class="org-ul">
<li>3 techniques for specifying in a test the behavior of a 3rd party system
<ol class="org-ol">
<li>stubbing adapter/gem methods</li>
<li>stubbing the HTTP requests triggered by those adapters/gems</li>
<li><i>In-Memory Fake Adapters</i></li>
</ol></li>
<li>Why?
<ul class="org-ul">
<li>It can tell a better story in our tests</li>
<li>Often used as a step of building <a href="http://www.growing-object-oriented-software.com/">a walking skeleton</a></li>
</ul></li>
<li>No need to stub every call</li>
<li>How to keep the fake adapter and the real one in sync?
<ol class="org-ol">
<li>Use the same test scenarios</li>
<li>Stub HTTP API responses in real adapter tests</li>
</ol></li>
<li>When to use Fake Adapters?
<ul class="org-ul">
<li>The more your API calls and business logic depend on previous API calls and
the state of the external system.</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org8a7257f" class="outline-3">
<h3 id="org8a7257f">4 ways to early return from a rails controller</h3>
<div class="outline-text-3" id="text-org8a7257f">
<p>
Why not <code>before_filter</code>? Because you may need to extract service objects out of
it.
</p>
<ol class="org-ol">
<li><code>redirect_to path and return</code> (classic)</li>
<li><code>extracted_method and/or return</code>
<ul class="org-ul">
<li><code>extracted_method</code> needs to return <code>true</code></li>
</ul></li>
<li><p>
<code>extracted_method { return }</code>
</p>
<div class="org-src-container">
<pre class="src src-ruby">class Controller
  def show
    verify_order { return }
  end

  private

  def verify_order
    unless @order.awaiting_payment? || @order.failed?
      redirect_to edit_order_path(@order) and yield
    end

    if invalid_order?
      redirect_to tickets_path(@order) and yield
    end
  end
end
</pre>
</div>
<ul class="org-ul">
<li>this can work but it's too implicit (because the second <code>yield</code> may not be
run)</li>
</ul></li>
<li><code>extracted_method; return if performed?</code>
<ul class="org-ul">
<li>Use <code>ActionController::Metal#performed?</code> to check whether render or
redirect already happened</li>
</ul></li>
</ol>
</div>
</div>
<div id="outline-container-org66e0245" class="outline-3">
<h3 id="org66e0245">Service::Input</h3>
<div class="outline-text-3" id="text-org66e0245">
<ul class="org-ul">
<li>The Issue
<ul class="org-ul">
<li><b>To see what attributes are being updated in the controller and for what
reason we would have to have a look at the views</b></li>
</ul></li>
<li>The Solution
<ul class="org-ul">
<li><b>Be explicit about arguments that your service can take</b></li>
<li><p>
Service::Input Example
</p>
<div class="org-src-container">
<pre class="src src-ruby">class OrderConfirmationService
  class Input &lt; Struct.new(:full_name, :email_address)
  end
end
</pre>
</div></li>
<li>Providing basic validation</li>
<li>Freeze input objects when all the attributes are set</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-orge3c266b" class="outline-3">
<h3 id="orge3c266b">Validations: Contexts</h3>
<div class="outline-text-3" id="text-orge3c266b">
<ul class="org-ul">
<li><p>
Use context to control when to call a validation
</p>
<div class="org-src-container">
<pre class="src src-ruby">class User
  validates_length_of :slug, minimum: 3, on: :user
  validates_length_of :slug, minimum: 1, on: :admin
end

class Admin::UsersController
  def edit
    # ...
    @user.save(context: :admin)
    # ...
  end
end
</pre>
</div></li>
<li><p>
Use <code>Object#with_options</code> provided by Rails to group validations
</p>
<div class="org-src-container">
<pre class="src src-ruby">class User
  with_options({on: :user}) do |for_user|
    for_user.validates_length_of :slug, minimum: 3
    for_user.validates_acceptance_of :terms_of_service
  end

  with_options({on: :admin}) do |for_admin|
    for_admin.validates_length_of :slug, minimum: 1
  end
end
</pre>
</div></li>
<li><b>But it conflicts with <code>on: :create</code> and <code>on: :update</code>, so you may need call
<code>valid?</code> more than once</b></li>
<li>It can be used to add validations <code>on: :destroy</code></li>
</ul>
</div>
</div>
<div id="outline-container-org6412bfa" class="outline-3">
<h3 id="org6412bfa">Validations: Objectify</h3>
<div class="outline-text-3" id="text-org6412bfa">
<ol class="org-ol">
<li><p>
Using <code>SimpleDelegator</code> to create a Validator
</p>
<div class="org-src-container">
<pre class="src src-ruby">class UserEditedByAdminValidator &lt; SimpleDelegator
  include ActiveModel::Validations

  validates_length_of :slug, minimum: 1
end
</pre>
</div></li>
<li><p>
Pass an object into <code>validates_with</code>
</p>
<div class="org-src-container">
<pre class="src src-ruby">class UserEditedByAdminValidator &lt; SimpleDelegator
  include ActiveModel::Validations

  validates_with LengthValidator, attributes: [:slug], minimum: 1
end
</pre>
</div></li>
<li><p>
Initiate an validator object using <code>validate</code>
</p>
<div class="org-src-container">
<pre class="src src-ruby">class UserEditedByAdminValidator &lt; SimpleDelegator
  include ActiveModel::Validations

  validate LengthValidator.new(attributes: [:slug], minimum: 1)
end
</pre>
</div></li>
<li><p>
Rule as an global object
</p>
<div class="org-src-container">
<pre class="src src-ruby">SlugMustHaveAtLeastOneCharacter =
  ActiveModel::Validations::LengthValidator.new(
    attributes: [:slug],
    minimum: 1
  )

class UserEditedByAdminValidator &lt; SimpleDelegator
  include ActiveModel::Validations

  validate SlugMustHaveAtLeastOneCharacter
end
</pre>
</div></li>
<li>and more...</li>
</ol>
</div>
</div>
</div>
<div id="outline-container-orgdaee1a2" class="outline-2">
<h2 id="orgdaee1a2">Testing</h2>
<div class="outline-text-2" id="text-orgdaee1a2">
</div>
<div id="outline-container-orga9127df" class="outline-3">
<h3 id="orga9127df">Introduction</h3>
<div class="outline-text-3" id="text-orga9127df">
<p>
<b>Distinguish tests by its stability</b>
</p>
<dl class="org-dl">
<dt>System tests</dt><dd>Stable</dd>
<dt>Unit tests</dt><dd>Unstable</dd>
</dl>
</div>
</div>
<div id="outline-container-orgeaa8122" class="outline-3">
<h3 id="orgeaa8122">Good test tells a story</h3>
<div class="outline-text-3" id="text-orgeaa8122">
<ol class="org-ol">
<li>User adds a product to the cart</li>
<li>User looks at the cart to see the current total amount</li>
<li>User changes the amount</li>
<li>User goes to checkout</li>
</ol>
</div>
</div>
<div id="outline-container-orge9d221d" class="outline-3">
<h3 id="orge9d221d">Unit tests vs class tests</h3>
<div class="outline-text-3" id="text-orge9d221d">
<ul class="org-ul">
<li>Test units, not classes
<ul class="org-ul">
<li><a href="http://andrzejonsoftware.blogspot.hk/2014/04/tdd-and-rails-what-makes-good-unit.html">Andrzej on Software: TDD and Rails - what makes a good Unit?</a></li>
<li><b>A class doesn’t usually make a good Unit, it’s usually a collection of
classes that is interesting.</b></li>
</ul></li>
<li>Benefits
<ol class="org-ol">
<li>I have the freedom of refactoring</li>
<li>I can think about the whole module as a black-box</li>
</ol></li>
<li><b>By writing low-level tests, you may be damaging the project</b>
<ul class="org-ul">
<li>Tests are code that you need to maintain</li>
<li>It also builds a more complex mental model</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org6d6522e" class="outline-3">
<h3 id="org6d6522e">Techniques</h3>
<div class="outline-text-3" id="text-org6d6522e">
</div>
<div id="outline-container-orgeb6a59e" class="outline-4">
<h4 id="orgeb6a59e">Service objects as a way of testing Rails apps (without factory_girl)</h4>
<div class="outline-text-4" id="text-orgeb6a59e">
<ul class="org-ul">
<li>Misuse of factories
<ul class="org-ul">
<li>We <b>try to build the state directly</b> (it's like using <code>instance_variable_set</code>)</li>
<li><i>But factory_girl is actually just sending <code>attribute=</code> message</i></li>
</ul></li>
<li>Solution
<ul class="org-ul">
<li><b>Setup tests by directly interacting with the system</b> using Service Objects</li>
<li>Extract them into smaller test helpers</li>
<li>Use <code>InMemoryRepositoy</code> to speed up data setup</li>
</ul></li>
</ul>
</div>
</div>
</div>
</div>
<div id="outline-container-org60a859b" class="outline-2">
<h2 id="org60a859b">Related topics</h2>
<div class="outline-text-2" id="text-org60a859b">
</div>
<div id="outline-container-orgf629b82" class="outline-3">
<h3 id="orgf629b82">Service controller communication</h3>
<div class="outline-text-3" id="text-orgf629b82">
<ol class="org-ol">
<li><code>true=/=false</code>
<ul class="org-ul">
<li>good for simple cases</li>
<li>breaks "Tell, don't Ask" (need to query created AR object again)</li>
</ul></li>
<li>return the object created/updated
<ul class="org-ul">
<li>combined with 1</li>
</ul></li>
<li>return a response object that contains all the data and/or errors
<ul class="org-ul">
<li><code>UserCreationResponse</code></li>
<li><code>successful?</code>, <code>failed?</code></li>
</ul></li>
<li>carry data through exceptions</li>
<li>controllers passes callback methods
<ul class="org-ul">
<li>pass <code>self</code> to services</li>
</ul></li>
</ol>
</div>
</div>
<div id="outline-container-orgb51ef5e" class="outline-3">
<h3 id="orgb51ef5e">Naming Conventions</h3>
<div class="outline-text-3" id="text-orgb51ef5e">
<ul class="org-ul">
<li>Class
<ul class="org-ul">
<li><code>RegisterUserService</code></li>
<li><code>RegisterUserUseCase</code></li>
<li><code>RegisterUser</code></li>
<li><code>UserRegister</code></li>
</ul></li>
<li>Method
<ul class="org-ul">
<li><code>call</code></li>
<li><code>execute</code></li>
<li><code>process</code></li>
<li><code>perform</code></li>
<li><code>run</code></li>
<li>custom name like <code>register</code></li>
</ul></li>
<li><p>
<code>.call</code> is special
</p>
<div class="org-src-container">
<pre class="src src-ruby">RegisterUser.new.call(foo, bar)

RegisterUser.new.(foo, bar)
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-orgb9e81fc" class="outline-3">
<h3 id="orgb9e81fc">Where to keep services</h3>
<div class="outline-text-3" id="text-orgb9e81fc">
<ul class="org-ul">
<li>Physical location
<ol class="org-ol">
<li>keep them in the <code>app/models</code> directory first</li>
<li>consider other places after becoming more familiar with it
<ol class="org-ol">
<li><code>app/models</code></li>
<li><code>app/services</code></li>
<li><code>app/feature_name</code></li>
<li><code>lib/feature_name</code></li>
</ol></li>
<li>feature at the highest-level (like <code>Phoenix.Context</code>)
<ol class="org-ol">
<li><code>time_tracking/models</code></li>
<li><code>time_tracking/services</code></li>
</ol></li>
</ol></li>
<li>Namespaces
<ul class="org-ul">
<li><b>Group your services according to the feature</b></li>
<li><b>Surround them with a proper namespace</b></li>
<li>Examples
<ul class="org-ul">
<li><code>TimeTracking::LogTimeService</code></li>
</ul></li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org4cde6a8" class="outline-3">
<h3 id="org4cde6a8">Routing constraints</h3>
<div class="outline-text-3" id="text-org4cde6a8">
<ul class="org-ul">
<li>Use routing constraints for situations where you need to choose different
actions based on some params</li>
<li>Useful when:
<ol class="org-ol">
<li>Refactoring controller without touching frontend</li>
<li>No power over incoming WebHook</li>
</ol></li>
</ul>
</div>
</div>
<div id="outline-container-orgb067103" class="outline-3">
<h3 id="orgb067103">Rails controller - the lifecycle</h3>
<div class="outline-text-3" id="text-orgb067103">
<ul class="org-ul">
<li><a href="http://andrewberls.com/blog/post/rails-from-request-to-response-part-1--introduction">Rails from Request to Response: Part 1 - Introduction - Andrew Berls</a></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-orgae5cd8c" class="outline-2">
<h2 id="orgae5cd8c">Bonus</h2>
<div class="outline-text-2" id="text-orgae5cd8c">
</div>
<div id="outline-container-org5512462" class="outline-3">
<h3 id="org5512462">Thanks to repositories</h3>
</div>
</div>

    </div>
</section>


    <div class="post-meta">
        <span title="post date" class="post-info">2018-02-11</span>
        <span title="last modification date" class="post-info">2018-02-11</span>
        <span title="tags" class="post-info"><a href="/tags/clipping/">Clipping</a>, <a href="/tags/rails/">Rails</a>, <a href="/tags/refactor/">Refactor</a>, <a href="/tags/service-object/">Service Object</a></span>
        <span title="author" class="post-info">Yiming Chen</span>
    </div>
  <section>
    <h1>Comments</h1>
      <div id="disqus_thread"></div>
      <script type="text/javascript">
       //var disqus_developer = 1;
       var disqus_identifier = "/clipping/2018/02/11/clippings-from-fearless-rails-refactoring";
       var disqus_url = "http://dsdshcym.github.io/clipping/2018/02/11/clippings-from-fearless-rails-refactoring";
       var disqus_shortname = 'dsdshcym-github-io';
       /* * * DON'T EDIT BELOW THIS LINE * * */
       (function() {
         var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
         dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
         (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
       })();
      </script>
      <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
      <a href="//disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
  </section>
<footer class="footer">
  <p>Generated by <a href="http://www.gnu.org/software/emacs/">Emacs</a> 26.x (<a href="http://orgmode.org">Org mode</a> 9.x)</p>
  <p>
    Copyright &copy; 2012 - <span id="footerYear"></span> <a href="mailto:dsdshcym &lt;at&gt; gmail &lt;dot&gt; com">Yiming Chen</a>
    &nbsp;&nbsp;-&nbsp;&nbsp;
    Powered by <a href="https://github.com/kelvinh/org-page" target="_blank">org-page</a>
    <script type="text/javascript">document.getElementById("footerYear").innerHTML = (new Date()).getFullYear();</script>
  </p>
</footer>

  </body>
</html>
